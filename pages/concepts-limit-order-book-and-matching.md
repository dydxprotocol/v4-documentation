# Limit Order Book and Matching

This document outlines the key differences between centralized exchanges and dYdX Chain, focusing on the decentralized limit order book and matching engine.


## Blockchain Overview
<!-- TODO: Move this to a general explainer section and link to it -->

dYdX Chain is a p2p blockchain network using [CosmosSDK](https://github.com/cosmos/cosmos-sdk) and [CometBFT](https://github.com/cometbft/cometbft) (formerly Tendermint).

Anyone can run a full node using the open-source software. Full nodes with sufficient delegated governance tokens participate in block building as validators.

The software repository is: https://github.com/dydxprotocol/v4-chain/

## Limit Order Book
Each full node in the network maintains an in-memory order book, which undergoes state changes in real time as traders submit order instructions.

Block proposers use trades from their local order book to build blocks, with matches generated by price-time priority. Since message arrival order varies between nodes, the order book may differ across the network at any given point in time. To address this, nodes partially sync their local books with each new consensus-committed block.

Clients can subscribe to a node's book state using the [Full Node Streaming API](./api_integration-full-node-streaming.md).

## Matching and Block Processing

The order matching logic is broadly similar to centralized exchanges, with some key differences:

1. On receiving a cancel instruction:
    - The node cancels the order unless it's already matched locally.
    - The cancel instruction is stored until it expires (based on the [GTB field](https://github.com/dydxprotocol/v4-chain/blob/4780b4cba2cab75e0af5675c3e87e551162ecf33/proto/dydxprotocol/clob/tx.proto#L90)).

2. On receiving an order:
    - The order fails to place if it has already been cancelled.
    - Otherwise, it is matched and/or placed on the order book, with optimistic matches stored locally.

3. Validator nodes propose blocks that include all their local matches.

4. When processing a new block:
    - The node starts from the state of the prior block (the local state used to propose is ignored).
    - The block’s changes are applied.
    - The node replays its local state on top of the new state, during which:
        - Cancels are preserved.
        - Orders matched in the prior local state are re-placed.
        - Orders may match differently, fail to place due to cancellation, or not match at all in the new state.

#### Source Code References
For further details on how the protocol handles these actions, refer to the following source code references:

- See [here](https://github.com/dydxprotocol/v4-chain/blob/dc6e0a004fd81e3139a24f88b10605ab5ce16cfd/protocol/x/clob/ante/clob.go#L90) and [here](https://github.com/dydxprotocol/v4-chain/blob/2d5dfa55357abd5ead46f8baa03ed76d420849cc/protocol/x/clob/memclob/memclob.go#L103) for how the protocol reacts when (1) a cancel is seen.

- When (2) [an order is placed](https://github.com/dydxprotocol/v4-chain/blob/dc6e0a004fd81e3139a24f88b10605ab5ce16cfd/protocol/x/clob/ante/clob.go#L132) and [checked to not be already cancelled](https://github.com/dydxprotocol/v4-chain/blob/749dff9cbca56eb2a6ab3a19feeb338de8db80e6/protocol/x/clob/keeper/orders.go#L780).

- When (3) [proposing a block](https://github.com/dydxprotocol/v4-chain/blob/189b11217490aa5a87a4108dde0f679b0190511b/protocol/app/prepare/prepare_proposal.go#L157).

- And (4) when [nodes process blocks committed by consensus](https://github.com/dydxprotocol/v4-chain/blob/4780b4cba2cab75e0af5675c3e87e551162ecf33/protocol/x/clob/abci.go#L152).

## Order Messages

Order instructions are limit order placements, replacements, and cancellations.

> Note: This section covers short-term orders which live off-chain, in node memory, until matched.
> 
> Stateful orders (on-chain, consensus-speed placement) exist for longer-lived limit orders but aren't recommended for API traders.
> More info: [Short-term vs Stateful Orders](./api_integration-trading/short_term_vs_stateful.mdx)


### Finality and GTB
Each limit order placement or cancellation [includes a GTB (good-til-block) field](https://github.com/dydxprotocol/v4-chain/blob/dc6e0a004fd81e3139a24f88b10605ab5ce16cfd/proto/dydxprotocol/clob/order.proto#L114-L146), which specifies the block height after which the instruction expires.

While rare, it is possible for a cancel instruction to be seen by the current block proposer but not by one or more subsequent proposers. In such cases, the order could still match after the sender expects it to have been cancelled.

Therefore, we recommend that API traders consider setting tight GTB values (e.g. the current chain height + 3) because expiry due to GTB is the only guaranteed way for an order to become unfillable. Consensus does not permit any order to fill at a height greater than its GTB.

### Replacements

We recommend using replacement instructions over cancelling and placing new orders.

Replacing prevents accidental double-fills that can occur with a ‘place order A, cancel order A, place order B’ approach, where both A and B might fill simultaneously unless the chain height has already passed A’s GTB.

#### Replacement Instruction Fields

To replace an order, send a placement with the same order ID **and a larger GTB value**.

Orders have the same ID if these client-specified fields match ([OrderId proto definition](https://github.com/dydxprotocol/v4-chain/blob/dcd2d9c2f6170bd19218d92cf6f2f88216b2ffe1/proto/dydxprotocol/clob/order.proto#L9-L41)):
- [Subaccount ID](https://github.com/dydxprotocol/v4-chain/blob/dcd2d9c2f6170bd19218d92cf6f2f88216b2ffe1/proto/dydxprotocol/subaccounts/subaccount.proto#L10-L17) (owner: signing address, number: 0 unless different subaccount)
- Client ID
- Order flags (0 for short-term orders)
- CLOB pair ID
